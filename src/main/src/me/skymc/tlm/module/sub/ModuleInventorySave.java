package me.skymc.tlm.module.sub;

import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;
import java.util.Set;

import org.bukkit.Material;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.inventory.ItemStack;

import me.skymc.taboolib.Main;
import me.skymc.taboolib.TabooLib;
import me.skymc.taboolib.message.MsgUtils;
import me.skymc.taboolib.playerdata.DataUtils;
import me.skymc.tlm.annotation.DisableConfig;
import me.skymc.tlm.inventory.TLMInventoryHolder;
import me.skymc.tlm.module.ITabooLibraryModule;

/**
 * @author sky
 * @since 2018年2月22日 下午2:48:27
 */
@DisableConfig
public class ModuleInventorySave implements ITabooLibraryModule, Listener {
	
	private FileConfiguration conf;

	@Override
	public String getName() {
		return "InventorySave";
	}
	
	@Override
	public void onEnable() {
		reloadConfig();
	}
	
	@Override
	public void onReload() {
		reloadConfig();
	}
	
	public void reloadConfig() {
		conf = DataUtils.addPluginData("InventorySave", Main.getInst());
	}
	
	/**
	 * 保存玩家背包
	 * 
	 * @param player 玩家
	 * @param name 名称
	 */
	public void saveInventory(Player player, String name) {
		// 设置物品
		for (int i = 0 ; i < (TabooLib.getVerint() > 10800 ? 41 : 40) ; i++) {
			ItemStack item = player.getInventory().getItem(i);
			conf.set(name + "." + i, item == null ? new ItemStack(Material.AIR) : item.clone());
		}
	}
	
	/**
	 * 覆盖玩家背包
	 * 
	 * @param player 玩家
	 * @param name 名称
	 */
	public void pasteInventory(Player player, String name) {
		// 如果背包不存在
		if (!conf.contains(name)) {
			MsgUtils.warn("模块执行异常: &4背包不存在");
			MsgUtils.warn("模块: &4InventorySave");
			MsgUtils.warn("位于: &4" + name);
			return;
		}
		
		// 设置物品
		for (int i = 0 ; i < (TabooLib.getVerint() > 10800 ? 41 : 40) ; i++) {
			try {
				ItemStack item = (ItemStack) conf.get(name + "." + i);
				player.getInventory().setItem(i, item);
			}
			catch (Exception e) {
				MsgUtils.warn("模块执行异常: &4物品覆盖出错");
				MsgUtils.warn("模块: &4InventorySave");
				MsgUtils.warn("位于: &4" + name + ":" + i);
			}
		}
	}
	
	/**
	 * 获取背包内所有物品
	 * 
	 * @param name 背包名称
	 * @return {@link List}
	 */
	public List<ItemStack> getItems(String name) {
		// 如果背包不存在
		if (!conf.contains(name)) {
			MsgUtils.warn("模块执行异常: &4背包不存在");
			MsgUtils.warn("模块: &4InventorySave");
			MsgUtils.warn("位于: &4" + name);
			return new LinkedList<>();
		}
		
		List<ItemStack> items = new LinkedList<>();
		// 设置物品
		for (int i = 0 ; i < (TabooLib.getVerint() > 10800 ? 41 : 40) ; i++) {
			try {
				ItemStack item = (ItemStack) conf.get(name + "." + i);
				items.add(item);
			}
			catch (Exception e) {
				MsgUtils.warn("模块执行异常: &4物品获取出错");
				MsgUtils.warn("模块: &4InventorySave");
				MsgUtils.warn("位于: &4" + name + ":" + i);
			}
		}
		return items;
	}
	
	/**
	 * 获取所有背包
	 * 
	 * @return {@link Set}
	 */
	public Set<String> getInventorys() {
		return conf.getConfigurationSection("").getKeys(false);
	}
	
	/**
	 * 删除背包
	 * 
	 * @param name 名称
	 */
	public void deleteInventory(String name) {
		conf.set(name, null);
	}
	
	@EventHandler
	public void onClick(InventoryClickEvent e) {
		if (!(e.getInventory().getHolder() instanceof TLMInventoryHolder)) {
			return;
		}
		
		TLMInventoryHolder holder = (TLMInventoryHolder) e.getInventory().getHolder();
		if (holder.getModule().equals(getName())) {
			e.setCancelled(true);
		} 
	}
}
